import { icons } from "./utils/utils.js";

window.baseurl = 'http://localhost/SistemaCRM/';
window.icons = await icons();
window.idusuario = document.getElementById('idUsuario')?.value || null;

window.getIcon = (name, color = null, size = null) => {
    const svgString = window.icons[name];
    if (!svgString) return '•';

    // Convertir string a nodo SVG
    const parser = new DOMParser();
    const doc = parser.parseFromString(svgString, "image/svg+xml");
    const svgElement = doc.documentElement;

    // Cambiar color si se pasó
    if (color) {
        svgElement.querySelectorAll("path").forEach(path => {
            path.style.stroke = color;
        });
    }

    if (size) {
        svgElement.setAttribute('style', `width: ${size}px !important; height: ${size}px !important;`)
    }

    return svgElement.outerHTML;
};

function previewImage(event) {
    const input = event.target;
    const file = input.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = document.getElementById('prev-image');
            img.src = e.target.result;
            img.style.display = 'block'; // Mostrar la imagen
        };
        reader.readAsDataURL(file);
    }
}

document.addEventListener('change', function (e) {
    if (e.target.closest('#fileInput')) {
        previewImage(e);
    }
});

document.addEventListener('click', function (e) {
    if (e.target.closest('.sidebar-item')) {
        window.location.href = `${e.target.closest('.sidebar-item').dataset.url}`;
    }
    if (e.target.closest('.user-icon') || e.target.closest('.user-link')) {
        const element = e.target.closest('.user-icon') || e.target.closest('.user-link');
        const tipo = element?.dataset?.type;
        const id = element?.dataset?.id;
        if (!element || !tipo || !id) return;

        if (tipo == 'usuario') {
            window.location.href = window.baseurl + `index.php?p=usuarios/get&id=${id}`;
        }
        if (tipo == 'cliente') {
            window.location.href = window.baseurl + `index.php?p=clientes/get&id=${id}`;
        }
    }
    /*
    if (e.target.closest('.input-busqueda')) {
        const input = e.target.closest('.input-busqueda');
        const resultadosContainer = document.querySelector(`.resultados-busqueda[data-parent="${input.id}"]`);

        if (!input || !resultadosContainer) return;
        resultadosContainer.style.display = 'flex';
    }
        */
    if (e.target.closest('.busqueda-grupo')) {
        const resultados = e.target.closest('.busqueda-grupo').querySelector('.resultados-busqueda');
        if (!resultados || resultados.classList.contains('disable-auto')) return;

        document.querySelectorAll('.resultados-busqueda').forEach(el => el.style.display = 'none');
        resultados.style.display = "flex";
    }
    if (e.target.closest('.resultado-item')) {
        const container = e.target.closest('.resultados-busqueda');
        if (!container || container.classList.contains('disable-auto')) return;

        const input = document.getElementById(container?.dataset?.parent);
        const value = e.target.closest('.resultado-item').dataset?.value;
        if (!value || !input) return;

        input.value = value;
        container.style.display = "none";
    }
    if (!e.target.closest('.menu-button')) {
        document.querySelectorAll('.menu-submenu').forEach(el => el.style.display = 'none');
    }
    if (!e.target.closest('.busqueda-grupo')) {
        document.querySelectorAll('.resultados-busqueda').forEach(el => el.style.display = 'none');
    }
});

document.addEventListener("show.bs.modal", function (event) {
    const openModals = document.querySelectorAll(".modal.show");
    if (openModals.length > 0) {
        const zIndex = 1050 + (10 * openModals.length); // base 1050, sumamos por cada modal abierto
        const modal = event.target;
        modal.style.zIndex = zIndex;

        // Ajustar el backdrop también
        setTimeout(() => {
            const backdrops = document.querySelectorAll(".modal-backdrop");
            backdrops[backdrops.length - 1].style.zIndex = zIndex - 1;
        });
    }
});